queue:
  name: Hosted VS2017
  timeoutInMinutes: 300

trigger:
  branches:
    include: ["master"]
  paths:
    exclude: [".github", "doc", "*.md", ".appveyor.yml"]

steps:
- task: Docker@0
  displayName: 'Build win-buildagent'
  inputs:
    azureSubscription: 'Azure Free Trial (c5eda4ed-4681-4034-8835-65d67e7d4b7c)'
    azureContainerRegistry: '{"loginServer":"andrewarnott.azurecr.io", "id" : "/subscriptions/c5eda4ed-4681-4034-8835-65d67e7d4b7c/resourceGroups/OSS/providers/Microsoft.ContainerRegistry/registries/andrewarnott"}'
    dockerFile: Dockerfile
    imageName: 'win-buildagent:$(Build.BuildId)'

- task: Docker@0
  displayName: 'Build win-vsts-agent'
  inputs:
    azureSubscription: 'Azure Free Trial (c5eda4ed-4681-4034-8835-65d67e7d4b7c)'
    azureContainerRegistry: '{"loginServer":"andrewarnott.azurecr.io", "id" : "/subscriptions/c5eda4ed-4681-4034-8835-65d67e7d4b7c/resourceGroups/OSS/providers/Microsoft.ContainerRegistry/registries/andrewarnott"}'
    dockerFile: 'vsts-agent/Dockerfile'
    imageName: 'win-vsts-agent:$(Build.BuildId)'

- task: Docker@0
  displayName: 'Push win-buildagent to ACR'
  inputs:
    azureSubscription: 'Azure Free Trial (c5eda4ed-4681-4034-8835-65d67e7d4b7c)'
    azureContainerRegistry: '{"loginServer":"andrewarnott.azurecr.io", "id" : "/subscriptions/c5eda4ed-4681-4034-8835-65d67e7d4b7c/resourceGroups/OSS/providers/Microsoft.ContainerRegistry/registries/andrewarnott"}'
    action: 'Push an image'
    imageName: 'win-buildagent:$(Build.BuildId)'
    includeSourceTags: true
    includeLatestTag: true

- task: Docker@0
  displayName: 'Push win-vsts-agent to ACR'
  inputs:
    azureSubscription: 'Azure Free Trial (c5eda4ed-4681-4034-8835-65d67e7d4b7c)'
    azureContainerRegistry: '{"loginServer":"andrewarnott.azurecr.io", "id" : "/subscriptions/c5eda4ed-4681-4034-8835-65d67e7d4b7c/resourceGroups/OSS/providers/Microsoft.ContainerRegistry/registries/andrewarnott"}'
    action: 'Push an image'
    imageName: 'win-vsts-agent:$(Build.BuildId)'
    includeSourceTags: true
    includeLatestTag: true

- task: Docker@0
  displayName: 'Push win-buildagent to Docker Hub'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: 'Docker Hub'
    action: 'Push an image'
    imageName: 'andrewarnott/win-buildagent:$(Build.BuildId)'
    includeSourceTags: true
    includeLatestTag: true

- task: Docker@0
  displayName: 'Push win-vsts-agent to Docker Hub'
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryConnection: 'Docker Hub'
    action: 'Push an image'
    imageName: 'andrewarnott/win-vsts-agent:$(Build.BuildId)'
    includeSourceTags: true
    includeLatestTag: true
